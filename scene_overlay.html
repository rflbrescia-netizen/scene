<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GitHub Slides — Overlay</title>
<style>
  html,body{margin:0;padding:0;overflow:hidden;background:transparent}
  .stage{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none}
  .frame{position:relative;width:100vw;height:100vh;display:grid;place-items:center}
  .media{
    max-width:100vw; max-height:100vh;
    width:auto; height:auto; object-fit:contain;
    opacity:0; transition:opacity 220ms ease-in-out;
    border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .visible{ opacity:var(--op,1); }
  #diag{position:fixed;top:8px;left:8px;padding:6px 10px;background:rgba(0,0,0,.45);color:#fff;font:12px system-ui;border-radius:8px;pointer-events:none}
</style>
</head>
<body>
  <div id="diag">state: <span id="dState">idle</span> · opacity: <span id="dOpacity">1.00</span></div>
  <div class="stage">
    <div class="frame" id="holder"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    /* ===== STESSO PROGETTO DEL CONTROLLER ===== */
    const firebaseConfig = {
      apiKey: "REPLACE_ME",
      authDomain: "REPLACE_ME.firebaseapp.com",
      projectId: "REPLACE_ME",
      storageBucket: "REPLACE_ME.appspot.com",
      messagingSenderId: "REPLACE_ME",
      appId: "REPLACE_ME",
      databaseURL: "https://REPLACE_ME-default-rtdb.europe-west1.firebasedatabase.app"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const holder   = document.getElementById('holder');
    const dState   = document.getElementById('dState');
    const dOpacity = document.getElementById('dOpacity');

    let globalOpacity = 1;
    onValue(dbRef(db, '/ghslides/opacity'), snap => {
      const v = Number(snap.val());
      globalOpacity = isFinite(v) ? Math.min(1, Math.max(0, v)) : 1;
      document.documentElement.style.setProperty('--op', String(globalOpacity));
      dOpacity.textContent = globalOpacity.toFixed(2);
    });

    onValue(dbRef(db, '/ghslides/current'), snap => {
      const v = snap.val();
      if (!v || !v.url){
        clearMedia();
        dState.textContent = 'hidden';
        return;
      }
      dState.textContent = 'showing';
      showMedia(v);
    });

    function clearMedia(){
      while(holder.firstChild) holder.removeChild(holder.firstChild);
    }

    function showMedia({ url, name, kind, nonce }){
      clearMedia();
      const bust = url + (url.includes('?') ? '&' : '?') + 't=' + (nonce || Date.now());

      if (kind === 'video'){
        const vid = document.createElement('video');
        vid.className = 'media';
        vid.src = bust;
        vid.muted = true; vid.autoplay = true; vid.loop = true; vid.playsInline = true;
        vid.setAttribute('crossorigin','anonymous');
        vid.oncanplay = ()=> vid.classList.add('visible');
        vid.onerror = ()=> dState.textContent = 'error(video)';
        holder.appendChild(vid);
        // Safari/iOS fallback: try play() after a tick
        setTimeout(()=> vid.play().catch(()=>{}), 100);
      } else {
        const img = document.createElement('img');
        img.className = 'media';
        img.src = bust; img.alt = name || '';
        img.setAttribute('crossorigin','anonymous');
        img.onload  = ()=> img.classList.add('visible');
        img.onerror = ()=> dState.textContent = 'error(image)';
        holder.appendChild(img);
      }
    }
  </script>
</body>
</html>

