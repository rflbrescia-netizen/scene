<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Slides Overlay — Fullscreen Show/Hide</title>
<style>
  html,body{margin:0;padding:0;overflow:hidden;background:transparent}
  .stage{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none}
  .frame{
    position:relative; width:100vw; height:100vh;
    display:grid; place-items:center;
  }
  img.slide{
    max-width:100vw; max-height:100vh;
    width:auto; height:auto; object-fit:contain;
    opacity:0; transition:opacity 220ms ease-in-out;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
    border-radius:12px;
    pointer-events:none;
  }
  .visible{ opacity:var(--op,1); }
  /* diagnostic (opzionale) */
  #diag{position:fixed; top:8px; left:8px; padding:6px 10px; background:rgba(0,0,0,.45); color:#fff; font:12px system-ui; border-radius:8px; pointer-events:none}
</style>
</head>
<body>
  <div id="diag">slides: <span id="dState">idle</span> · opacity: <span id="dOpacity">1.00</span></div>
  <div class="stage">
    <div class="frame">
      <img id="slide" class="slide" alt="">
    </div>
  </div>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
'use strict';

// === Stesso progetto del controller ===
const firebaseConfig = {
  apiKey: "AIzaSyBwClPtAF4TDN5ndFUoouL0zXIYlyGdx1k",
  authDomain: "scene-75f23.firebaseapp.com",
  projectId: "scene-75f23",
  storageBucket: "scene-75f23.firebasestorage.app",
  messagingSenderId: "261453827889",
  appId: "1:261453827889:web:005b387590b4c52f322a10"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const img = document.getElementById('slide');
const dState = document.getElementById('dState');
const dOpacity = document.getElementById('dOpacity');

// Opacità globale
let globalOpacity = 1;
db.ref('/slides/opacity').on('value', snap => {
  const v = Number(snap.val());
  globalOpacity = isFinite(v) ? Math.min(1, Math.max(0, v)) : 1;
  document.documentElement.style.setProperty('--op', String(globalOpacity));
  dOpacity.textContent = globalOpacity.toFixed(2);
});

// Slide corrente
db.ref('/slides/current').on('value', snap => {
  const v = snap.val();
  if (!v || !v.url){
    dState.textContent = 'hidden';
    img.classList.remove('visible');
    // attendo la transizione per pulire src (evita flicker)
    setTimeout(()=>{ img.removeAttribute('src'); img.alt=''; }, 230);
    return;
  }
  dState.textContent = 'showing';
  // carico nuova immagine, poi visibilità
  const url = v.url + (v.url.includes('?') ? '&' : '?') + 't=' + (v.nonce || Date.now()); // cache-bust
  img.classList.remove('visible');
  // se l’immagine è già in cache, l’evento load può non scattare: forzo step
  const applyVisible = ()=>requestAnimationFrame(()=> img.classList.add('visible'));
  img.onload = applyVisible;
  img.onerror = ()=>{ dState.textContent = 'error'; img.classList.remove('visible'); };
  img.src = url;
  img.alt = v.name || '';
});
  </script>
</body>
</html>
