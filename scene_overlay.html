<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GitHub Slides â€” Overlay</title>
<style>
  html,body{margin:0;padding:0;overflow:hidden;background:transparent}
  .stage{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none}
  .frame{position:relative;width:100vw;height:100vh;display:grid;place-items:center}
  .media{
    max-width:100vw; max-height:100vh;
    width:auto; height:auto; object-fit:contain;
    opacity:0; transition:opacity 220ms ease-in-out;
    border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .visible{ opacity:var(--op,1); }
  #diag{position:fixed;top:8px;left:8px;padding:6px 10px;background:rgba(0,0,0,.45);color:#fff;font:12px system-ui;border-radius:8px;pointer-events:none}

  /* Unmute hint (per browser standard) */
  .unmute-hint{
    position:fixed; bottom:6%; left:50%; transform:translateX(-50%);
    padding:10px 14px; border-radius:999px;
    background:rgba(0,0,0,.6); color:#fff; font:14px/1 system-ui;
    pointer-events:auto; cursor:pointer; user-select:none;
    box-shadow:0 6px 20px rgba(0,0,0,.35);
  }
  .unmute-hint.hidden{ display:none; }
</style>
</head>
<body>
  <div id="diag">state: <span id="dState">idle</span> Â· opacity: <span id="dOpacity">1.00</span> Â· forceAudio: <span id="dForce">false</span></div>
  <button id="unmuteBtn" class="unmute-hint hidden">ðŸ”Š Tocca per attivare lâ€™audio</button>
  <div class="stage">
    <div class="frame" id="holder"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    /* ===== STESSO PROGETTO DEL CONTROLLER ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBkce58GlbHRRmHSNyGQyDiqmxuuNll2Ys",
  authDomain: "scene1-45a13.firebaseapp.com",
  databaseURL: "https://scene1-45a13-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "scene1-45a13",
  storageBucket: "scene1-45a13.appspot.com",
  messagingSenderId: "15156197967",
  appId: "1:15156197967:web:2b9caac05000641352083a"
};
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const holder   = document.getElementById('holder');
    const dState   = document.getElementById('dState');
    const dOpacity = document.getElementById('dOpacity');
    const dForce   = document.getElementById('dForce');
    const unmuteBtn = document.getElementById('unmuteBtn');

    let globalOpacity = 1;
    let wantAudio     = false;  // preferenza dal controller (browser standard)
    let forceAudio    = false;  // Streamlabs/OBS: prova a partire con audio subito
    let lastVideo     = null;

    onValue(dbRef(db, '/ghslides/opacity'), snap => {
      const v = Number(snap.val());
      globalOpacity = isFinite(v) ? Math.min(1, Math.max(0, v)) : 1;
      document.documentElement.style.setProperty('--op', String(globalOpacity));
      dOpacity.textContent = globalOpacity.toFixed(2);
    });

    onValue(dbRef(db, '/ghslides/sound'), snap => {
      wantAudio = !!snap.val();
      applyAudioPreference();
    });

    onValue(dbRef(db, '/ghslides/forceAudio'), snap => {
      forceAudio = !!snap.val();
      dForce.textContent = String(forceAudio);
      applyAudioPreference();
    });

    onValue(dbRef(db, '/ghslides/current'), snap => {
      const v = snap.val();
      if (!v || !v.url){
        clearMedia();
        dState.textContent = 'hidden';
        return;
      }
      dState.textContent = 'showing';
      showMedia(v);
    });

    function clearMedia(){
      lastVideo = null;
      while(holder.firstChild) holder.removeChild(holder.firstChild);
      unmuteBtn.classList.add('hidden');
    }

    function showMedia({ url, name, kind, nonce }){
      clearMedia();
      const bust = url + (url.includes('?') ? '&' : '?') + 't=' + (nonce || Date.now());

      if (kind === 'video'){
        const vid = document.createElement('video');
        vid.className = 'media';
        vid.src = bust;
        vid.playsInline = true;
        vid.autoplay   = true;
        vid.loop       = true;
        vid.setAttribute('crossorigin','anonymous');

        // Strategia audio:
        // - se forceAudio=true (Streamlabs/OBS), tenta subito audio ON
        // - altrimenti, parte muto e si usa preferenza wantAudio + hint
        if (forceAudio){
          vid.muted  = false;
          vid.volume = 1;
        } else {
          vid.muted  = true;
          vid.volume = 0;
        }

        let playTries = 0;
        const tryPlay = () => {
          vid.play().catch(() => {
            if (++playTries < 5) setTimeout(tryPlay, 200);
          });
        };

        vid.oncanplay = ()=>{
          vid.classList.add('visible');
          lastVideo = vid;
          if (forceAudio){
            vid.muted = false; vid.volume = 1;
            unmuteBtn.classList.add('hidden');
          } else {
            applyAudioPreference(); // gestisce hint se wantAudio=true
          }
          tryPlay();
        };
        vid.onerror = ()=> dState.textContent = 'error(video)';
        holder.appendChild(vid);
        setTimeout(tryPlay, 100);
      } else {
        const img = document.createElement('img');
        img.className = 'media';
        img.src = bust; img.alt = name || '';
        img.setAttribute('crossorigin','anonymous');
        img.onload  = ()=> img.classList.add('visible');
        img.onerror = ()=> dState.textContent = 'error(image)';
        holder.appendChild(img);
      }
    }

    function applyAudioPreference(){
      if (!lastVideo) return;
      if (forceAudio){
        // Streamlabs/OBS: niente hint, forza audio
        lastVideo.muted = false;
        lastVideo.volume = 1;
        unmuteBtn.classList.add('hidden');
        return;
      }
      // Browser standard
      if (wantAudio){
        if (lastVideo.muted) {
          unmuteBtn.classList.remove('hidden'); // serve un gesto
        }
      } else {
        lastVideo.muted = true;
        lastVideo.volume = 0;
        unmuteBtn.classList.add('hidden');
      }
    }

    unmuteBtn.addEventListener('click', ()=>{
      if (!lastVideo) return;
      lastVideo.muted = false;
      lastVideo.volume = 1;
      lastVideo.play().catch(()=>{});
      unmuteBtn.classList.add('hidden');
    });
  </script>
</body>
</html>

