<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Slides Controller — Upload & Show/Hide (v9 + progress + retry)</title>
<style>
  :root{ --bg:#0b111a; --panel:#121826; --muted:#9fb0cc; --accent:#39d5ff; --danger:#ff5575; --ok:#78ffb3; }
  html,body{margin:0;padding:0;background:var(--bg);color:#e9eef9;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 16px;background:#0f1522;border-bottom:1px solid rgba(255,255,255,.08)}
  h1{margin:0;font-size:18px}
  .wrap{padding:14px;display:grid;gap:14px;grid-template-columns:1fr}
  .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px}
  .card h2{margin:0 0 8px;font-size:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0d1624;color:#e9eef9;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .btn-accent{background:var(--accent);color:#001018;font-weight:800}
  .btn-danger{background:var(--danger);color:#2c0009;font-weight:800}
  .btn-ok{background:var(--ok);color:#00140a;font-weight:800}
  .tiny{font-size:12px;color:var(--muted)}
  input[type="range"]{width:200px}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .item{display:grid;gap:8px;background:#0c1422;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:10px}
  .thumb{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:8px;background:#0a0f18}
  .name{font-weight:700}

  /* Upload list with progress */
  .uploads{display:grid;gap:8px}
  .up-row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;background:#0c1422;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:10px}
  .up-name{font-weight:600}
  .up-bar{position:relative;height:10px;background:#0b111b;border:1px solid rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
  .up-fill{position:absolute;inset:0 100% 0 0;background:var(--accent)}
  .up-meta{font-size:12px;color:var(--muted)}
  .up-ok{color:var(--ok);font-weight:700}
  .up-err{color:var(--danger);font-weight:700}

  @media (max-width: 720px){
    .btn{padding:12px 14px}
    input[type="range"]{width:160px}
  }
</style>
</head>
<body>
<header><h1>Slides Controller — Upload & Show/Hide</h1></header>

<div class="wrap">
  <section class="card">
    <h2>Carica immagini</h2>
    <div class="row">
      <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.webp" multiple />
      <button class="btn btn-accent" id="btnUpload" type="button">Upload</button>
      <span id="upStatus" class="tiny"></span>
    </div>
    <div class="uploads" id="uploads"></div>
    <p class="tiny">Limiti (modificabili nel codice): max 20 file / max 25 MB per file.</p>
  </section>

  <section class="card">
    <h2>Opacità overlay</h2>
    <div class="row">
      <input type="range" min="0" max="100" value="100" id="opacityRange" />
      <span id="opacityVal" class="tiny">100%</span>
      <button class="btn" id="btnSaveOpacity" type="button">Applica</button>
      <span id="opStatus" class="tiny"></span>
    </div>
  </section>

  <section class="card">
    <h2>Galleria</h2>
    <div id="grid" class="grid"></div>
    <p class="tiny" id="listStatus"></p>
  </section>
</div>

<!-- Firebase v9 (modular) via CDN -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref as dbRef, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { getStorage, ref as stRef, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  /* === Configura il TUO progetto === */
 const firebaseConfig = {
  apiKey: "AIzaSyBwClPtAF4TDN5ndFUoouL0zXIYlyGdx1k",
  authDomain: "scene-75f23.firebaseapp.com",
  projectId: "scene-75f23",
  storageBucket: "scene-75f23.firebasestorage.app",
  messagingSenderId: "261453827889",
  appId: "1:261453827889:web:005b387590b4c52f322a10"
};

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const st  = getStorage(app);

  // DOM
  const $ = s => document.querySelector(s);
  const grid = $('#grid');
  const upStatus = $('#upStatus');
  const listStatus = $('#listStatus');
  const opStatus = $('#opStatus');
  const uploadsEl = $('#uploads');
  const range = $('#opacityRange');
  const rangeVal = $('#opacityVal');

  range.addEventListener('input', () => rangeVal.textContent = range.value + '%');
  $('#btnSaveOpacity').addEventListener('click', saveOpacity);
  $('#btnUpload').addEventListener('click', uploadFiles);

  // Live lista items
  let items = {};
  onValue(dbRef(db, '/slides/items'), (snap) => {
    items = snap.val() || {};
    renderList(items);
  });

  // ==== LIMITI (puoi modificarli) ====
  const MAX_FILES = 20;
  const MAX_SIZE_MB = 25;
  const MAX_RETRIES = 3;

  // Utils upload UI
  function addUploadRow(name){
    const row = document.createElement('div');
    row.className = 'up-row';
    row.innerHTML = `
      <div>
        <div class="up-name">${name}</div>
        <div class="up-bar"><div class="up-fill"></div></div>
        <div class="up-meta tiny">In attesa…</div>
      </div>
      <div class="up-meta tiny"></div>
    `;
    uploadsEl.prepend(row);
    return {
      row,
      fill: row.querySelector('.up-fill'),
      meta: row.querySelector('.up-meta'),
      right: row.lastElementChild
    };
  }
  function setUploadProgress(ui, pct){
    ui.fill.style.inset = `0 ${100-pct}% 0 0`;
    ui.meta.textContent = `Caricamento: ${pct}%`;
  }
  function setUploadDone(ui, url){
    ui.fill.style.inset = `0 0 0 0`;
    ui.meta.innerHTML = `<span class="up-ok">Completato</span>`;
    ui.right.innerHTML = `<a href="${url}" target="_blank" class="tiny">Apri</a>`;
  }
  function setUploadError(ui, msg){
    ui.meta.innerHTML = `<span class="up-err">Errore:</span> ${msg}`;
  }

  // Carica file multipli con progress + retry
  async function uploadFiles(){
    const input = document.getElementById('fileInput');
    const files = Array.from(input.files || []);
    if(!files.length){ upStatus.textContent = 'Seleziona uno o più file.'; return; }

    // Limiti
    if (files.length > MAX_FILES){
      upStatus.textContent = `Max ${MAX_FILES} file per upload.`;
      return;
    }
    const tooBig = files.filter(f => f.size > MAX_SIZE_MB * 1024 * 1024);
    if (tooBig.length){
      upStatus.textContent = `File troppo grandi (> ${MAX_SIZE_MB} MB): ${tooBig.map(f=>f.name).join(', ')}`;
      return;
    }

    upStatus.textContent = `Upload in corso… (0/${files.length})`;
    let done = 0;

    for (const f of files){
      const ui = addUploadRow(f.name);

      const cleanName = f.name.replace(/\s+/g,'_');
      const path = `slides/${Date.now()}_${Math.random().toString(36).slice(2,6)}_${cleanName}`;
      const ref = stRef(st, path);

      try{
        const snap = await uploadWithRetry(ref, f, ui, MAX_RETRIES);
        const url = await getDownloadURL(snap.ref);

        // salva su DB
        const key = push(dbRef(db, '/slides/items')).key;
        await set(dbRef(db, `/slides/items/${key}`), {
          id: key, name: f.name, path, url, createdAt: Date.now()
        });

        setUploadDone(ui, url);
        done++;
        upStatus.textContent = `Upload in corso… (${done}/${files.length})`;
      }catch(e){
        console.error('Upload error', e);
        setUploadError(ui, e?.message || String(e));
      }
    }

    input.value = '';
    upStatus.textContent = 'Upload terminato.';
  }

  // Upload con retry ed exponential backoff
  function uploadWithRetry(ref, file, ui, maxRetries=3){
    let attempt = 0;

    return new Promise((resolve, reject) => {
      const start = () => {
        attempt++;
        ui.meta.textContent = `Inizio upload (tentativo ${attempt}/${maxRetries})…`;

        const task = uploadBytesResumable(ref, file);

        let lastProgressTs = Date.now();
        const watchdog = setInterval(()=>{
          // se per 60s non avanza, rifacciamo (solo se non superato max tentativi)
          if (Date.now() - lastProgressTs > 60000){
            console.warn('Timeout avanzamento upload, ri-provo…', ref.fullPath);
            clearInterval(watchdog);
            task.cancel(); // causerà "storage/canceled"
          }
        }, 5000);

        task.on('state_changed',
          (snap)=>{
            if (snap.totalBytes){
              const pct = Math.floor((snap.bytesTransferred / snap.totalBytes) * 100);
              lastProgressTs = Date.now();
              setUploadProgress(ui, pct);
            }
          },
          async (err)=>{
            clearInterval(watchdog);
            // Se tentativi rimasti e errore transitorio → retry
            const transientCodes = new Set([
              'storage/retry-limit-exceeded',
              'storage/unknown',
              'storage/canceled',
              'storage/quota-exceeded',
              'storage/unauthorized',
              'storage/network-request-failed'
            ]);
            if (attempt < maxRetries && transientCodes.has(err?.code || 'storage/unknown')){
              const delay = 500 * Math.pow(2, attempt-1); // backoff 0.5s, 1s, 2s…
              ui.meta.textContent = `Errore transitorio (${err.code||'unknown'}). Retry tra ${delay} ms…`;
              setTimeout(start, delay);
            } else {
              reject(err);
            }
          },
          ()=>{
            clearInterval(watchdog);
            resolve(task.snapshot);
          }
        );
      };

      start();
    });
  }

  // Mostra lista
  function renderList(map){
    grid.innerHTML = '';
    const ids = Object.keys(map);
    if (!ids.length){ listStatus.textContent = 'Nessuna immagine caricata.'; return; }
    listStatus.textContent = `${ids.length} immagini.`;
    ids.sort((a,b)=> map[b].createdAt - map[a].createdAt);
    ids.forEach(id => {
      const it = map[id];
      const card = document.createElement('div');
      card.className = 'item';
      card.innerHTML = `
        <img class="thumb" src="${it.url}" alt="${it.name}">
        <div class="name">${it.name}</div>
        <div class="row">
          <button class="btn btn-accent" data-act="show" data-id="${id}" type="button">Mostra</button>
          <button class="btn" data-act="hide" data-id="${id}" type="button">Nascondi</button>
          <button class="btn btn-danger" data-act="del"  data-id="${id}" type="button">Elimina</button>
        </div>
      `;
      card.querySelector('[data-act="show"]').onclick = ()=> showSlide(id);
      card.querySelector('[data-act="hide"]').onclick = hideSlide;
      card.querySelector('[data-act="del"]').onclick  = ()=> deleteSlide(id);
      grid.appendChild(card);
    });
  }

  // Comandi overlay
  async function showSlide(id){
    const it = items[id]; if (!it) return;
    await set(dbRef(db, '/slides/current'), { id, url: it.url, name: it.name, nonce: Date.now() });
  }
  async function hideSlide(){
    await set(dbRef(db, '/slides/current'), null);
  }
  async function deleteSlide(id){
    const it = items[id]; if (!it) return;
    if (!confirm(`Eliminare "${it.name}"?`)) return;
    try{
      await deleteObject(stRef(st, it.path));
    }catch(e){
      console.warn('Storage delete warning:', e?.message||e);
    }
    await set(dbRef(db, `/slides/items/${id}`), null);
  }

  // Opacità globale (0-100) → 0..1
  async function saveOpacity(){
    const v = Math.max(0, Math.min(100, parseInt(range.value || '100',10)));
    await set(dbRef(db, '/slides/opacity'), v/100);
    opStatus.textContent = `Opacità impostata a ${v}%`;
    setTimeout(()=> opStatus.textContent = '', 1500);
  }
</script>
</body>
</html>
