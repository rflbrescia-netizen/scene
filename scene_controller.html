<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Slides Controller — Upload & Show/Hide</title>
<style>
  :root{ --bg:#0b111a; --panel:#121826; --muted:#9fb0cc; --accent:#39d5ff; --danger:#ff5575; --ok:#78ffb3; }
  html,body{margin:0;padding:0;background:var(--bg);color:#e9eef9;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 16px;background:#0f1522;border-bottom:1px solid rgba(255,255,255,.08)}
  h1{margin:0;font-size:18px}
  .wrap{padding:14px;display:grid;gap:14px;grid-template-columns:1fr}
  .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px}
  .card h2{margin:0 0 8px;font-size:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0d1624;color:#e9eef9;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .btn-accent{background:var(--accent);color:#001018;font-weight:800}
  .btn-danger{background:var(--danger);color:#2c0009;font-weight:800}
  .btn-ok{background:var(--ok);color:#00140a;font-weight:800}
  .tiny{font-size:12px;color:var(--muted)}
  input[type="range"]{width:200px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .item{display:grid;gap:8px;background:#0c1422;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:10px}
  .thumb{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:8px;background:#0a0f18}
  .name{font-weight:700}
  @media (max-width: 720px){
    .btn{padding:12px 14px}
    input[type="range"]{width:160px}
  }
</style>
</head>
<body>
<header><h1>Slides Controller — Upload & Show/Hide</h1></header>

<div class="wrap">
  <section class="card">
    <h2>Carica immagini</h2>
    <div class="row">
      <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.webp" multiple />
      <button class="btn btn-accent" id="btnUpload" type="button">Upload</button>
      <span id="upStatus" class="tiny"></span>
    </div>
    <p class="tiny">Suggerito: PNG/JPG/WebP. Le immagini saranno mostrate a tutto schermo (fit “contain”).</p>
  </section>

  <section class="card">
    <h2>Opacità overlay</h2>
    <div class="row">
      <input type="range" min="0" max="100" value="100" id="opacityRange" />
      <span id="opacityVal" class="tiny">100%</span>
      <button class="btn" id="btnSaveOpacity" type="button">Applica</button>
      <span id="opStatus" class="tiny"></span>
    </div>
  </section>

  <section class="card">
    <h2>Galleria</h2>
    <div id="grid" class="grid"></div>
    <p class="tiny" id="listStatus"></p>
  </section>
</div>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script>
'use strict';

// === Sostituisci con il tuo progetto (qui riuso quello degli esempi) ===
const firebaseConfig = {
  apiKey: "AIzaSyBwClPtAF4TDN5ndFUoouL0zXIYlyGdx1k",
  authDomain: "scene-75f23.firebaseapp.com",
  projectId: "scene-75f23",
  storageBucket: "scene-75f23.firebasestorage.app",
  messagingSenderId: "261453827889",
  appId: "1:261453827889:web:005b387590b4c52f322a10"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

const $ = s => document.querySelector(s);
const grid = $('#grid');
const upStatus = $('#upStatus');
const listStatus = $('#listStatus');
const opStatus = $('#opStatus');

document.getElementById('btnUpload').addEventListener('click', uploadFiles);
document.getElementById('btnSaveOpacity').addEventListener('click', saveOpacity);
const range = document.getElementById('opacityRange');
const rangeVal = document.getElementById('opacityVal');
range.addEventListener('input', () => rangeVal.textContent = range.value + '%');

// Live lista items
let items = {};
db.ref('/slides/items').on('value', snap => {
  items = snap.val() || {};
  renderList(items);
});

// Carica file multipli su Storage + salva metadati su DB (robusto)
async function uploadFiles(){
  const input = document.getElementById('fileInput');
  const files = input.files;
  if(!files || !files.length){ upStatus.textContent = 'Seleziona uno o più file.'; return; }

  // Controllo config più comune
  if (!firebase.apps.length || !firebase.storage){
    upStatus.textContent = 'Firebase non inizializzato correttamente.';
    return;
  }
  const cfg = firebase.app().options;
  if (!cfg || !cfg.storageBucket || !cfg.storageBucket.endsWith('appspot.com')){
    upStatus.textContent = 'Attenzione: storageBucket non è *.appspot.com — correggi firebaseConfig.';
    return;
  }

  upStatus.textContent = `Upload in corso… (0/${files.length})`;
  const storageRef = firebase.storage().ref();

  let done = 0;
  for (const f of files){
    const cleanName = f.name.replace(/\s+/g,'_');
    const path = `slides/${Date.now()}_${cleanName}`;
    const ref = storageRef.child(path);

    // Resumable upload + progress
    const task = ref.put(f); // compat: put() è già resumable; se usi modular v9 usa uploadBytesResumable
    let lastPct = 0;
    let aborted = false;

    // Watchdog: se non avanza per 60s, abort
    let lastProgressTs = Date.now();
    const watchdog = setInterval(()=>{
      if (Date.now() - lastProgressTs > 60000){ // 60s senza avanzare
        aborted = true;
        try { task.cancel && task.cancel(); } catch(_) {}
        console.warn('Upload watchdog: annullato per timeout', path);
      }
    }, 5000);

    await new Promise((resolve, reject)=>{
      task.on('state_changed',
        (snap)=>{
          // progress
          if (snap.totalBytes) {
            const pct = Math.floor((snap.bytesTransferred / snap.totalBytes) * 100);
            if (pct !== lastPct) {
              lastPct = pct;
              lastProgressTs = Date.now();
              upStatus.textContent = `Upload in corso… ${pct}% (${cleanName})`;
            }
          }
        },
        (err)=>{
          clearInterval(watchdog);
          console.error('Upload error', err);
          reject(err);
        },
        async ()=>{
          clearInterval(watchdog);
          if (aborted) return reject(new Error('Upload annullato per timeout'));
          try{
            const url = await ref.getDownloadURL();
            const key = db.ref('/slides/items').push().key;
            await db.ref(`/slides/items/${key}`).set({
              id: key, name: f.name, path, url, createdAt: Date.now()
            });
            done++;
            upStatus.textContent = `Upload in corso… (${done}/${files.length})`;
            resolve();
          }catch(e){
            reject(e);
          }
        }
      );
    });
  }

  input.value = '';
  upStatus.textContent = 'Upload completato ✔';
}


// Mostra lista
function renderList(map){
  grid.innerHTML = '';
  const ids = Object.keys(map);
  if (!ids.length){ listStatus.textContent = 'Nessuna immagine caricata.'; return; }
  listStatus.textContent = `${ids.length} immagini.`;
  ids.sort((a,b)=> map[b].createdAt - map[a].createdAt);
  ids.forEach(id => {
    const it = map[id];
    const card = document.createElement('div');
    card.className = 'item';
    card.innerHTML = `
      <img class="thumb" src="${it.url}" alt="${it.name}">
      <div class="name">${it.name}</div>
      <div class="row">
        <button class="btn btn-accent" data-act="show" data-id="${id}" type="button">Mostra</button>
        <button class="btn" data-act="hide" data-id="${id}" type="button">Nascondi</button>
        <button class="btn btn-danger" data-act="del"  data-id="${id}" type="button">Elimina</button>
      </div>
    `;
    card.querySelector('[data-act="show"]').onclick = ()=> showSlide(id);
    card.querySelector('[data-act="hide"]').onclick = hideSlide;
    card.querySelector('[data-act="del"]').onclick  = ()=> deleteSlide(id);
    grid.appendChild(card);
  });
}

// Comandi overlay
async function showSlide(id){
  const it = items[id]; if (!it) return;
  await db.ref('/slides/current').set({ id, url: it.url, name: it.name, nonce: Date.now() });
}
async function hideSlide(){
  await db.ref('/slides/current').set(null);
}
async function deleteSlide(id){
  const it = items[id]; if (!it) return;
  if (!confirm(`Eliminare "${it.name}"?`)) return;
  try{
    await storage.ref().child(it.path).delete();
  }catch(e){ console.warn('Storage delete warning:', e); }
  await db.ref(`/slides/items/${id}`).set(null);
}

// Opacità globale (0-100) → 0..1
async function saveOpacity(){
  const v = Math.max(0, Math.min(100, parseInt(range.value || '100',10)));
  await db.ref('/slides/opacity').set(v/100);
  opStatus.textContent = `Opacità impostata a ${v}%`;
}
</script>
</body>
</html>
