<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GitHub Slides — Controller</title>
<style>
  :root{ --bg:#0b111a; --panel:#121826; --muted:#9fb0cc; --accent:#39d5ff; --danger:#ff5575; --ok:#78ffb3; }
  html,body{margin:0;padding:0;background:var(--bg);color:#e9eef9;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:14px 16px;background:#0f1522;border-bottom:1px solid rgba(255,255,255,.08)}
  h1{margin:0;font-size:18px}
  .wrap{padding:14px;display:grid;gap:14px;grid-template-columns:1fr}
  .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px}
  .card h2{margin:0 0 8px;font-size:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input[type="text"]{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0b111b;color:#e9eef9}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0d1624;color:#e9eef9;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .btn-accent{background:var(--accent);color:#001018;font-weight:800}
  .btn-danger{background:var(--danger);color:#2c0009;font-weight:800}
  .btn-ok{background:var(--ok);color:#00140a;font-weight:800}
  .tiny{font-size:12px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .item{display:grid;gap:8px;background:#0c1422;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:10px}
  .thumb{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:8px;background:#0a0f18}
  .name{font-weight:700}
  .badge{font-size:11px;padding:2px 6px;border-radius:6px;background:#0b111b;color:#9fb0cc;width:max-content}
  @media (max-width: 720px){ .btn{padding:12px 14px} input[type="text"]{width:100%} .row input{flex:1} }
</style>
</head>
<body>
<header><h1>GitHub Slides — Controller</h1></header>

<div class="wrap">

  <section class="card">
    <h2>Sorgente GitHub</h2>
    <div class="row">
      <div>
        <label>Owner</label>
        <input type="text" id="ghOwner" value="rflbrescia-netizen">
      </div>
      <div>
        <label>Repository</label>
        <input type="text" id="ghRepo" value="roster">
      </div>
      <div>
        <label>Cartella (opz.)</label>
        <input type="text" id="ghPath" value="" placeholder="es. slides">
      </div>
      <div style="min-width:260px">
        <label>Token GitHub (opz., per repo private o rate limit)</label>
        <input type="text" id="ghToken" placeholder="ghp_...">
      </div>
      <button class="btn btn-accent" id="btnScan" type="button">Scansiona repo</button>
      <span id="scanStatus" class="tiny"></span>
    </div>
    <p class="tiny">Supporto: immagini <code>.jpg .jpeg .png .webp .gif</code> e video <code>.mp4 .webm</code>. I file devono essere pubblici nel repo.</p>
  </section>

  <section class="card">
    <h2>Comandi Overlay</h2>
    <div class="row">
      <button class="btn" id="btnHide" type="button">Nascondi</button>
      <span class="tiny">nasconde la slide corrente</span>
    </div>
  </section>

  <section class="card">
    <h2>Opacità overlay</h2>
    <div class="row">
      <input type="range" min="0" max="100" value="100" id="opacityRange" />
      <span id="opacityVal" class="tiny">100%</span>
      <button class="btn" id="btnSaveOpacity" type="button">Applica</button>
      <span id="opStatus" class="tiny"></span>
    </div>
  </section>

  <section class="card">
    <h2>Galleria (GitHub)</h2>
    <div id="grid" class="grid"></div>
    <p id="listStatus" class="tiny"></p>
  </section>

</div>

<!-- Firebase v9 (modular) via CDN -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref as dbRef, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  /* ===== CONFIGURA QUI IL TUO PROGETTO (Realtime DB) =====
     Usa la URL REGIONALE (es: europe-west1.firebasedatabase.app) */
const firebaseConfig = {
  apiKey: "AIzaSyBkce58GlbHRRmHSNyGQyDiqmxuuNll2Ys",
  authDomain: "scene1-45a13.firebaseapp.com",
  databaseURL: "https://scene1-45a13-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "scene1-45a13",
  storageBucket: "scene1-45a13.appspot.com",
  messagingSenderId: "15156197967",
  appId: "1:15156197967:web:2b9caac05000641352083a"
};
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // UI refs
  const $ = s => document.querySelector(s);
  const grid = $('#grid');
  const listStatus = $('#listStatus');
  const scanStatus = $('#scanStatus');
  const opStatus = $('#opStatus');
  const range = $('#opacityRange'); const rangeVal = $('#opacityVal');
  range.addEventListener('input', ()=> rangeVal.textContent = range.value + '%');

  // Bind
  document.getElementById('btnScan').addEventListener('click', scanRepo);
  document.getElementById('btnHide').addEventListener('click', hideSlide);
  document.getElementById('btnSaveOpacity').addEventListener('click', saveOpacity);

  // Live feedback (mostra l’elemento attualmente attivo)
  onValue(dbRef(db, '/ghslides/current'), snap => {
    const v = snap.val();
    if (v && v.url) {
      scanStatus.textContent = 'Mostrando: ' + (v.name || v.url);
    } else {
      scanStatus.textContent = 'Nessuna slide attiva.';
    }
  });

  // Scansiona repo GitHub e popola la galleria
  async function scanRepo(){
    const owner = $('#ghOwner').value.trim();
    const repo  = $('#ghRepo').value.trim();
    const path  = $('#ghPath').value.trim().replace(/^\/+|\/+$/g,'');
    const token = $('#ghToken').value.trim();
    if(!owner || !repo){ alert('Inserisci owner e repo.'); return; }

    const base = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents`;
    const api  = path ? `${base}/${encodeURIComponent(path)}` : base;

    scanStatus.textContent = 'Scansione in corso…';
    const headers = { 'Accept': 'application/vnd.github+json' };
    if(token) headers['Authorization'] = 'Bearer ' + token;

    try{
      const res = await fetch(api, { cache:'no-store', headers });
      if(!res.ok){
        const t = await res.text();
        throw new Error(`GitHub HTTP ${res.status}: ${t.slice(0,160)}`);
      }
      const items = await res.json();
      const mediaExt = ['.jpg','.jpeg','.png','.webp','.gif','.mp4','.webm'];
      const files = (Array.isArray(items) ? items : []).filter(x=>{
        const name = (x?.name || '').toLowerCase();
        return x?.type === 'file' && mediaExt.some(ext => name.endsWith(ext));
      });

      if(!files.length){ grid.innerHTML=''; listStatus.textContent='Nessun file supportato trovato.'; scanStatus.textContent=''; return; }

      // Normalizza: preferisci x.download_url, fallback raw
      const normalized = files.map(f=>{
        const url = f.download_url || toRaw(owner, repo, path, f.name);
        const lower = f.name.toLowerCase();
        const kind = (lower.endsWith('.mp4') || lower.endsWith('.webm')) ? 'video' : 'image';
        return { id: f.sha || f.path || f.name, name: f.name, url, kind };
      });
      renderList(normalized);
      listStatus.textContent = `${normalized.length} file.`;
      scanStatus.textContent = 'Scansione OK.';
    }catch(e){
      console.error(e);
      scanStatus.textContent = 'Errore: ' + (e?.message || e);
      alert('Errore scansione: ' + (e?.message || e));
    }
  }

  function renderList(items){
    grid.innerHTML = '';
    items.forEach(it=>{
      const card = document.createElement('div');
      card.className = 'item';
      const preview = (it.kind === 'image')
        ? `<img class="thumb" src="${it.url}" alt="${it.name}" loading="lazy">`
        : `<video class="thumb" src="${it.url}" muted playsinline></video>`;
      card.innerHTML = `
        ${preview}
        <div class="name">${it.name}</div>
        <span class="badge">${it.kind.toUpperCase()}</span>
        <div class="row">
          <button class="btn btn-accent" type="button">Mostra</button>
          <button class="btn" type="button">Nascondi</button>
        </div>
      `;
      const [btnShow, btnHide] = card.querySelectorAll('button');
      btnShow.onclick = ()=> showSlide(it);
      btnHide.onclick = ()=> hideSlide();
      grid.appendChild(card);
    });
  }

  // Comandi overlay (DB only)
  async function showSlide(it){
    await set(dbRef(db, '/ghslides/current'), {
      id: it.id, url: it.url, name: it.name, kind: it.kind, nonce: Date.now()
    });
  }
  async function hideSlide(){
    await set(dbRef(db, '/ghslides/current'), null);
  }
  async function saveOpacity(){
    const v = Math.max(0, Math.min(100, parseInt(range.value || '100',10)));
    await set(dbRef(db, '/ghslides/opacity'), v/100);
    opStatus.textContent = `Opacità impostata a ${v}%`;
    setTimeout(()=> opStatus.textContent='', 1500);
  }

  function toRaw(owner, repo, path, name){
    const p = path ? (path.replace(/^\/+|\/+$/g,'') + '/') : '';
    return `https://raw.githubusercontent.com/${owner}/${repo}/HEAD/${p}${name}`;
  }
</script>
</body>
</html>
